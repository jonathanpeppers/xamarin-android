<?xml version="1.0" encoding="UTF-8" ?>
<!--
***********************************************************************************************
Xamarin.Android.Application.targets

WARNING:  DO NOT MODIFY this file unless you are knowledgeable about MSBuild and have
  created a backup copy.  Incorrect changes to this file will make it
  impossible to load or build your projects from the command-line or the IDE.

Copyright (C) 2019 Microsoft Corporation. All rights reserved.
***********************************************************************************************
-->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <UsingTask TaskName="Xamarin.Android.Tasks.GetAndroidActivityName" AssemblyFile="Xamarin.Android.Build.Tasks.dll" />
  <Target Name="StartAndroidActivity"
      DependsOnTargets="_ResolveMonoAndroidSdks">
    <GetAndroidActivityName
        Condition=" '$(AndroidLaunchActivity)' == '' "
        ManifestFile="$(IntermediateOutputPath)android\AndroidManifest.xml">
      <Output TaskParameter="ActivityName" PropertyName="AndroidLaunchActivity" />
    </GetAndroidActivityName>
    <GetAndroidPackageName
        ManifestFile="$(IntermediateOutputPath)android\AndroidManifest.xml"
        AssemblyName="$(AssemblyName)">
      <Output TaskParameter="PackageName" PropertyName="_AndroidPackage" />
    </GetAndroidPackageName>
    <Exec Command="&quot;$(AdbToolPath)\adb&quot; $(AdbTarget) shell am start -n &quot;$(_AndroidPackage)/$(AndroidLaunchActivity)&quot;" />
  </Target>
  <Target Name="StopAndroidPackage"
      DependsOnTargets="_ResolveMonoAndroidSdks">
    <GetAndroidPackageName
        ManifestFile="$(IntermediateOutputPath)android\AndroidManifest.xml"
        AssemblyName="$(AssemblyName)">
      <Output TaskParameter="PackageName" PropertyName="_AndroidPackage" />
    </GetAndroidPackageName>
    <Exec Command="&quot;$(AdbToolPath)\adb&quot; $(AdbTarget) shell am force-stop &quot;$(_AndroidPackage)&quot;" />
  </Target>
  <Target Name="LaunchDebugger">
    <PropertyGroup>
      <AndroidSdbTargetPort Condition="'$(AndroidSdbTargetPort)' == ''">10000</AndroidSdbTargetPort>
      <AndroidSdbHostPort Condition="'$(AndroidSdbHostPort)' == ''">10000</AndroidSdbHostPort>
      <AndroidAttachDebugger Condition="'$(AndroidAttachDebugger)' == ''">False</AndroidAttachDebugger>
      <!--NOTE: This doesn't work on Windows, I had to harcode a number like 1674366208-->
      <_AndroidDebuggerTimeout>2000</_AndroidDebuggerTimeout>
    </PropertyGroup>
    <Exec Command="&quot;$(AdbToolPath)\adb&quot; $(AdbTarget) forward tcp:$(AndroidSdbTargetPort) tcp:$(AndroidSdbHostPort)"
      Condition="'$(AndroidAttachDebugger)' == 'True'" />
    <Exec Command="&quot;$(AdbToolPath)\adb&quot; $(AdbTarget) shell echo %24((%24(date +%25s)+$(_AndroidDebuggerTimeout)))"
        ConsoleToMsBuild="True"
        Condition="'$(AndroidAttachDebugger)' == 'True'">
      <Output ItemName="_DeviceDate" TaskParameter="ConsoleOutput" />
    </Exec>
    <Exec Command="&quot;$(AdbToolPath)\adb&quot; $(AdbTarget) shell setprop debug.mono.extra debug=127.0.0.1:$(AndroidSdbTargetPort),timeout=@(_DeviceDate),loglevel=0,server=y"
      Condition="'$(AndroidAttachDebugger)' == 'True'"/>
    <CallTarget Targets="StartAndroidActivity" />
  </Target>
</Project>
